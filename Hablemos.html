<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mensajes Recibidos</title>
  <link rel="stylesheet" href="hablemos.css" />
</head>
<body>

<header>
  <h1>Mensajes Recibidos</h1>
</header>

<section class="table-container">
  <table>
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Email</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="messagesBody">
      <!-- Mensajes se cargan aquí -->
    </tbody>
  </table>
</section>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="modal-card">
    <button class="modal-close" id="modalClose">X</button>
    <div class="modal-body" id="modalBody">
      <!-- Contenido del mensaje -->
    </div>
  </div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz8BGx1s-JNZVE4gmHi3fDltzKQ76m8BwDuEeGiJPaPtgauKNqwBO8IIhSS71CWHNAr/exec"; 
const messagesBody = document.getElementById("messagesBody");
const modal = document.getElementById("modal");
const modalBody = document.getElementById("modalBody");
const modalClose = document.getElementById("modalClose");

let currentMessageId = null;

// Cargar mensajes
async function loadMessages(){
  try{
    const res = await fetch(WEB_APP_URL);
    const data = await res.json();
    messagesBody.innerHTML = "";

    data.forEach(msg=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${msg.nombre}</td>
        <td>${msg.email}</td>
        <td>
          <button class="delete-btn" data-id="${msg.id}">Borrar</button>
        </td>
      `;
      // Abrir modal al hacer click en nombre/email
      tr.querySelector("td:first-child").addEventListener("click", ()=> openModal(msg));
      tr.querySelector("td:nth-child(2)").addEventListener("click", ()=> openModal(msg));
      // Borrar mensaje
      tr.querySelector(".delete-btn").addEventListener("click", async (e)=>{
        e.stopPropagation();
        if(!confirm("¿Seguro quieres borrar este mensaje?")) return;
        try{
          const res = await fetch(`${WEB_APP_URL}?deleteId=${msg.id}`);
          const result = await res.json();
          if(result.status==="success"){
            alert(result.message);
            loadMessages();
          } else {
            alert("Error: "+result.message);
          }
        }catch(err){
          console.error(err);
          alert("Error borrando mensaje.");
        }
      });
      messagesBody.appendChild(tr);
    });
  }catch(e){
    console.error("Error cargando mensajes:", e);
  }
}

// Abrir modal
function openModal(msg){
  currentMessageId = msg.id;
  modalBody.innerHTML = `
    <p><strong>ID:</strong> ${msg.id}</p>
    <p><strong>Nombre:</strong> ${msg.nombre}</p>
    <p><strong>Email:</strong> ${msg.email}</p>
    <p><strong>Mensaje:</strong> ${msg.mensaje}</p>
  `;
  modal.style.display = "flex";
}

// Cerrar modal
modalClose.addEventListener("click", ()=> modal.style.display="none");

// Auto refresco cada 5 segundos
setInterval(loadMessages, 5000);
document.addEventListener("DOMContentLoaded", loadMessages);
</script>

</body>
</html>
